<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .login-form { text-align: left; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid black; }
        th, td { padding: 4px; text-align: left; }
        .form-section { margin-top: 20px; }
        .error { color: red; }
        button { width: 80px; margin-right: 5px; }
        .action-buttons { white-space: nowrap; }
        h1 { text-align: center; }
        body {
            margin: 40px auto;
            max-width: 800px;
            line-height: 1.6;
            font-size: 18px;
            color: #444;
            padding: 0 10px;
        }
        h1, h2, h3 { line-height: 1.2; }
        #musicButton:hover { cursor: pointer; }
        /* Safari */
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<button
        id="musicButton"
        onclick="toggleMusic()"
        style="
        color: rgba(5, 0, 0, 0.5);
        outline: none;
        border: none;
        height: 50px;
        width: 50px;
        font-size: 25px;
        position: fixed;
        bottom: 5%;
        right: 5%;
        background: #d3d3d370;
        border-radius: 50%;
      "
>
    â™ª
</button>
<iframe
        id="video"
        src="https://www.youtube.com/embed/videoseries?list=PLA3CdKbUxlGToJVhFK-R7sY0yoEKEwwkp"
        style="position: absolute; width: 0; height: 0; border: 0"
        allow="autoplay"
>
</iframe>

<div id="loader" style="display: none">
    <img src="nochesLogo.png" style="width: 60px; border-radius: 50%" alt="uh-oh" />
</div>

<div class="container">
    {% if not session.logged_in %}
    <div class="login-form">
        <h1>Nebula Admin Login</h1>
        <form action="/nebula/login" method="post">
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
        {% if error %}
        <p class="error">{{ error }}</p>
        {% endif %}
    </div>
    {% else %}
    <h1>Nebula Admin Panel</h1>
    <a href="/nebula/logout">Logout</a>

    <table id="hostsTable">
        <thead>
        <tr>
            <th>VPN IP</th>
            <th>Ping</th>
            <th>Name</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <!-- Manual enrollment row -->
        <tr>
            <td>
                <form action="/api/enroll" method="post" style="display:inline;">
                    <span>192.168.100.</span>
                    <input type="number" name="ip_octet" min="2" max="254" placeholder="2-254" style="width: 50px;" required>
                    <td>N/A</td>
                    <td>
                        <input type="text" name="group_name" placeholder="Name" required>
                    </td>
                    <td>
                        <button type="submit">Add</button>
                    </td>
                </form>
            </td>
        </tr>
        {% for host in hosts %}
        <tr>
            <td>{{ host[1] }}</td>
            <td>{{ host[3] }} ms</td>
            <td>
                <form action="/api/rename" method="post" style="display:inline;">
                    <input type="hidden" name="host_id" value="{{ host[0] }}">
                    <input type="text" name="new_group_name" value="{{ host[2] }}" required>
                    <button type="submit" {% if host[1] == "192.168.100.1" %}disabled{% endif %}>Rename</button>
                </form>
            </td>
            <td class="action-buttons">
                <form action="/api/download_config" method="post" style="display:inline;">
                    <input type="hidden" name="host_id" value="{{ host[0] }}">
                    <button type="submit" {% if host[1] == "192.168.100.1" %}disabled{% endif %}>Download</button>
                </form>
                <form action="/api/remove" method="post" style="display:inline;">
                    <input type="hidden" name="host_id" value="{{ host[0] }}">
                    <button type="submit" {% if host[1] == "192.168.100.1" %}disabled{% endif %}>Remove</button>
                </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<script>
    const autoplay = '&autoplay=1';
    function toggleMusic() {
        const video = document.getElementById('video');
        const musicButton = document.getElementById('musicButton');
        let contains = video.src.includes(autoplay);

        if (contains) {
            video.src = video.src.replace(autoplay, '');
            musicButton.style.background = '#d3d3d370';
        } else {
            video.src += autoplay;
            musicButton.style.background = `linear-gradient(-45deg, #0A197A, #00D4FF)`;
        }
    }

    // Periodically fetch updated hosts list
    async function updateHosts() {
        try {
            const response = await fetch('/api/hosts');
            if (!response.ok) throw new Error('Failed to fetch hosts');
            const hosts = await response.json();

            const tbody = document.querySelector('#hostsTable tbody');
            tbody.innerHTML = '';

            // Manual enrollment row
            tbody.innerHTML += `
                <tr>
                    <td>
                        <form action="/api/enroll" method="post" style="display:inline;">
                            <span>192.168.100.</span>
                            <input type="number" name="ip_octet" min="2" max="254" placeholder="2-254" style="width: 50px;" required>
                            <td>N/A</td>
                            <td>
                                <input type="text" name="group_name" placeholder="Name" required>
                            </td>
                            <td>
                                <button type="submit">Add</button>
                            </td>
                        </form>
                    </td>
                </tr>
            `;

            // Add hosts
            hosts.forEach(host => {
                const disabled = host[1] === '192.168.100.1' ? 'disabled' : '';
                tbody.innerHTML += `
                    <tr>
                        <td>${host[1]}</td>
                        <td>${host[3]} ms</td>
                        <td>
                            <form action="/api/rename" method="post" style="display:inline;">
                                <input type="hidden" name="host_id" value="${host[0]}">
                                <input type="text" name="new_group_name" value="${host[2]}" required>
                                <button type="submit" ${disabled}>Rename</button>
                            </form>
                        </td>
                        <td class="action-buttons">
                            <form action="/api/download_config" method="post" style="display:inline;">
                                <input type="hidden" name="host_id" value="${host[0]}">
                                <button type="submit" ${disabled}>Download</button>
                            </form>
                            <form action="/api/remove" method="post" style="display:inline;">
                                <input type="hidden" name="host_id" value="${host[0]}">
                                <button type="submit" ${disabled}>Remove</button>
                            </form>
                        </td>
                    </tr>
                `;
            });
        } catch (err) {
            console.error('Error updating hosts:', err);
        }
    }

    // Call once on page load
    document.addEventListener('DOMContentLoaded', updateHosts);
</script>
</body>
</html>